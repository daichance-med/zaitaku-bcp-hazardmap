<!DOCTYPE html>
<!--
=========================================
åœ¨å®…BCPãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚¢ãƒ—ãƒª v2.2.8
=========================================

Copyright (c) 2026 ç¦äº•ã€€å¤§æ²»éƒ
All Rights Reserved.

æœ¬ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãŠã‚ˆã³é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä»¥ä¸‹ã€Œæœ¬ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã€ï¼‰ã¯ã€
è‘—ä½œæ¨©æ³•ã«ã‚ˆã‚Šä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã€ä½¿ç”¨è¨±å¯ã€‘
å€‹äººãƒ»æ³•äººã‚’å•ã‚ãšã€ä»¥ä¸‹ã®æ¡ä»¶ã®ä¸‹ã§ä½¿ç”¨ã‚’è¨±å¯ã—ã¾ã™ï¼š
ãƒ»æ¥­å‹™ã§ã®ä½¿ç”¨OKï¼ˆè¨ªå•çœ‹è­·ã€è¨ªå•è¨ºç™‚ã€è¨ªå•ä»‹è­·ç­‰ï¼‰
ãƒ»å€‹äººåˆ©ç”¨OK
ãƒ»æ”¹å¤‰ãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºOK
ãƒ»ç„¡æ–™ã§ã®å†é…å¸ƒOK

ã€ç¦æ­¢äº‹é …ã€‘
ãƒ»æœ¬ã‚¢ãƒ—ãƒªã®è²©å£²ï¼ˆæœ‰æ–™é…å¸ƒï¼‰
ãƒ»æœ¬ã‚¢ãƒ—ãƒªã‚’ä½¿ã£ãŸæœ‰æ–™ã‚µãƒ¼ãƒ“ã‚¹ã®æä¾›
ãƒ»è‘—ä½œæ¨©è¡¨ç¤ºã®å‰Šé™¤

å…è²¬äº‹é …ï¼š
æœ¬ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯ã€Œç¾çŠ¶ã®ã¾ã¾ã€æä¾›ã•ã‚Œã¾ã™ã€‚
ä½¿ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸæå®³ã«ã¤ã„ã¦ã€è‘—ä½œæ¨©è€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚

é–‹ç™ºè€…: ç¦äº•ã€€å¤§æ²»éƒ
æœ€çµ‚æ›´æ–°: 2026å¹´2æœˆ11æ—¥
=========================================
-->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>åœ¨å®…BCPãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚¢ãƒ—ãƒª v2.2.8</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- SheetJS for Excel processing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            overflow: auto;
        }
        
        /* ============ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ ============ */
        #uploadScreen {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        .upload-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .app-title {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .app-title h1 {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .app-title .subtitle {
            color: #7f8c8d;
            font-size: 0.95em;
        }
        
        .app-title .version {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7em;
            margin-top: 8px;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 16px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: scale(1.02);
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f3ff;
            border-width: 4px;
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .upload-area h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-area p {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        #fileInput {
            display: none;
        }
        
        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 12px;
            border-left: 4px solid #4caf50;
            display: none;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-container {
            margin-top: 20px;
            display: none;
            animation: slideIn 0.3s;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #2c3e50;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .progress-status {
            margin-top: 10px;
            font-size: 0.85em;
            color: #7f8c8d;
            text-align: center;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            display: none;
            animation: slideIn 0.3s;
        }
        
        .status.success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .status.error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .status.info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .status.warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        
        .error-list {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            font-size: 0.85em;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .error-list-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .error-list-item:last-child {
            border-bottom: none;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ============ åœ°å›³ç”»é¢ ============ */
        #mapScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ */
        .info-box {
            position: absolute;
            top: 10px;
            left: 10px;
            max-width: 250px;
            background: white;
            padding: 12px 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .info-box h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1em;
        }
        
        .info-box .clinic-name {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .info-box .stats {
            font-size: 0.8em;
            line-height: 1.8;
            color: #34495e;
        }
        
        .info-box .risk-summary {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        
        .info-box .risk-item {
            flex: 1;
            text-align: center;
            padding: 6px 4px;
            border-radius: 8px;
            font-size: 0.7em;
        }
        
        .risk-high { background: #ffebee; color: #c62828; font-weight: bold; }
        .risk-mid { background: #fff8e1; color: #f57f17; font-weight: bold; }
        .risk-low { background: #e8f5e9; color: #2e7d32; }
        
        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        .back-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 28px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            font-weight: bold;
            color: #667eea;
            border: 2px solid #667eea;
            transition: all 0.3s;
            font-size: 1em;
        }
        
        .back-btn:hover {
            background: #667eea;
            color: white;
            transform: translateX(-50%) scale(1.05);
        }
        
        .back-btn:active {
            transform: translateX(-50%) scale(0.95);
        }
        
        .save-json-btn:hover {
            background: #229954 !important;
            transform: scale(1.05);
        }
        
        .save-json-btn:active {
            transform: scale(0.95);
        }
        
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .patient-popup {
            padding: 15px;
            min-width: 250px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .patient-popup .patient-count-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 12px;
        }
        
        .patient-popup .address {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.05em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .patient-popup .name {
            color: #34495e;
            margin-bottom: 10px;
            padding-left: 5px;
            font-size: 1em;
            font-weight: 500;
        }
        
        .patient-popup .risk-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .patient-popup .risk-badge.high { background: #ff5252; color: white; }
        .patient-popup .risk-badge.mid { background: #ffb300; color: white; }
        .patient-popup .risk-badge.low { background: #66bb6a; color: white; }
        
        .patient-popup .notes {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
            border-radius: 6px;
        }
        
        .patient-popup .notes-label {
            font-weight: bold;
            color: #856404;
            margin-bottom: 5px;
        }
        
        .patient-popup .phone-section {
            margin-top: 12px;
            padding: 12px;
            background: #f0f3ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .patient-popup .phone-label {
            color: #7f8c8d;
            font-size: 0.8em;
            margin-bottom: 6px;
        }
        
        .patient-popup .phone-number {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .patient-popup .phone-number.has-phone { color: #2980b9; }
        .patient-popup .phone-number.no-phone { color: #95a5a6; font-style: italic; }
        
        .patient-popup .call-button {
            display: block;
            padding: 12px;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        }
        
        .patient-popup .call-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }
        
        .patient-popup .call-button:active {
            transform: translateY(0);
        }
        
        /* ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .leaflet-control-layers {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 768px) {
            .upload-container {
                padding: 25px;
            }
            
            .app-title h1 {
                font-size: 1.5em;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .upload-icon {
                font-size: 3em;
            }
            
            .info-box {
                padding: 10px 12px;
                max-width: 200px;
                font-size: 0.9em;
            }
            
            .info-box h3 { font-size: 0.85em; }
            .info-box .stats { font-size: 0.7em; }
            .info-box .clinic-name { font-size: 0.75em; }
            .info-box .risk-item { font-size: 0.65em; padding: 5px 3px; }
            
            .back-btn {
                font-size: 0.9em;
                padding: 10px 20px;
            }
            
            .patient-popup {
                min-width: 220px;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- åˆ©ç”¨è¦ç´„ç”»é¢ -->
    <div id="termsScreen" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center; flex-direction: column;">
        <div style="background: white; padding: 40px; border-radius: 15px; max-width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="color: #e74c3c; margin-top: 0; font-size: 24px;">âš ï¸ é‡è¦ï¼šã”åˆ©ç”¨å‰ã®ç¢ºèª</h2>
            
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px;">
                <strong style="color: #856404;">ã“ã®ã‚¢ãƒ—ãƒªã¯æ‚£è€…ã®å€‹äººæƒ…å ±ã‚’å–ã‚Šæ‰±ã„ã¾ã™</strong>
            </div>
            
            <h3 style="color: #2c3e50; font-size: 18px; margin-top: 25px;">ã€ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦ã€‘</h3>
            <ul style="line-height: 1.8; color: #34495e;">
                <li>æœ¬ã‚¢ãƒ—ãƒªã¯<strong>ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å®Œçµ</strong>ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¾ã›ã‚“</li>
                <li>æ‚£è€…æƒ…å ±ã®ç®¡ç†è²¬ä»»ã¯<strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆäº‹æ¥­æ‰€ï¼‰</strong>ã«ã‚ã‚Šã¾ã™</li>
                <li>åœ°å›³ä½œæˆå¾Œã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯<strong>å®‰å…¨ã«ä¿ç®¡</strong>ã—ã¦ãã ã•ã„</li>
                <li>ãƒ•ã‚¡ã‚¤ãƒ«ã®æš—å·åŒ–ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ç­‰ã¯<strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è²¬ä»»</strong>ã§ã™</li>
            </ul>
            
            <h3 style="color: #e74c3c; font-size: 18px; margin-top: 25px;">ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ³¨æ„ã€‘</h3>
            <ul style="line-height: 1.8; color: #34495e;">
                <li>âš ï¸ USBãƒ¡ãƒ¢ãƒªç­‰ã§ã®æŒã¡é‹ã³ã«ã¯<strong>æš—å·åŒ–USB</strong>ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„</li>
                <li>âš ï¸ é›»å­ã‚«ãƒ«ãƒ†ç«¯æœ«ã¨åŒã˜PCã§ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™</li>
                <li>âš ï¸ ä½¿ç”¨å¾Œã¯<strong>ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å®Œå…¨ã«é–‰ã˜ã¦</strong>ãã ã•ã„</li>
                <li>âš ï¸ å…±æœ‰PCã§ã®ä½¿ç”¨ã¯é¿ã‘ã¦ãã ã•ã„</li>
            </ul>
            
            <h3 style="color: #2c3e50; font-size: 18px; margin-top: 25px;">ã€å…è²¬äº‹é …ã€‘</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 14px; line-height: 1.8; color: #495057;">
                æœ¬ã‚¢ãƒ—ãƒªã®ä½¿ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸæå®³ï¼ˆå€‹äººæƒ…å ±æ¼æ´©ã‚’å«ã‚€ï¼‰ã«ã¤ã„ã¦ã€é–‹ç™ºè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚å€‹äººæƒ…å ±ä¿è­·æ³•ã®éµå®ˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è²¬ä»»ã§ã™ã€‚
            </div>
            
            <h3 style="color: #2c3e50; font-size: 18px; margin-top: 25px;">ã€ä½¿ç”¨ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã€‘</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 14px; line-height: 1.8; color: #495057;">
                æœ¬ã‚¢ãƒ—ãƒªã¯ã€å›½åœŸäº¤é€šçœã€Œãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆã€ï¼ˆ<a href="https://disaportal.gsi.go.jp/" target="_blank" style="color: #667eea;">https://disaportal.gsi.go.jp/</a>ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŠ å·¥ã—ã¦ä½œæˆã—ã¦ã„ã¾ã™ã€‚<br>
                èƒŒæ™¯åœ°å›³ã«ã¯ OpenStreetMap ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 16px;">
                    <input type="checkbox" id="agreeCheckbox" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                    <span style="color: #2e7d32; font-weight: bold;">ä¸Šè¨˜ã®å†…å®¹ã‚’ç†è§£ã—ã€åŒæ„ã—ã¾ã™</span>
                </label>
            </div>
            
            <button id="agreeButton" disabled style="width: 100%; padding: 15px; margin-top: 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: not-allowed;">
                åŒæ„ã—ã¦é–‹å§‹
            </button>
        </div>
    </div>
    
    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ -->
    <div id="uploadScreen">
        <div class="upload-container">
            <div class="app-title">
                <h1>ğŸ—ºï¸ åœ¨å®…BCPãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—</h1>
                <p class="subtitle">æ‚£è€…ä½æ‰€ã¨ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’è‡ªå‹•ã§çµ±åˆ</p>
                <span class="version">v2.2.8</span>
                <p style="margin-top: 15px; padding: 10px 20px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 0.9em; color: #555;">
                    ğŸ’¡ å®Œå…¨ç„¡æ–™ãƒ»æ‹¡æ•£æ­“è¿ï½œåŒåƒšãƒ»å‹äººã¸ã®ç´¹ä»‹ã€SNSã‚·ã‚§ã‚¢å¤§æ­“è¿ã§ã™
                </p>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <h2>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</h2>
                <p><strong>Excelãƒ•ã‚¡ã‚¤ãƒ«</strong>ï¼ˆ.xlsx, .xlsï¼‰</p>
                <p><strong>CSVãƒ•ã‚¡ã‚¤ãƒ«</strong>ï¼ˆ.csvï¼‰é›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰å‡ºåŠ›</p>
                <p><strong>ä¿å­˜ã—ãŸåœ°å›³</strong>ï¼ˆ.jsonï¼‰å‰å›ä½œæˆã—ãŸBCPåœ°å›³</p>
                <p style="margin-top: 10px; color: #95a5a6; font-size: 0.85em;">
                    ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </p>
                
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.json">
            </div>
            
            <div class="file-info" id="fileInfo"></div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <span id="progressLabel">åº§æ¨™å¤‰æ›ä¸­...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBar">0%</div>
                </div>
                <div class="progress-status" id="progressStatus"></div>
            </div>
            
            <div class="loader" id="loader"></div>
            <div class="status" id="status"></div>
        </div>
    </div>
    
    <!-- åœ°å›³ç”»é¢ -->
    <div id="mapScreen">
        <div id="map"></div>
        
        <div class="info-box">
            <h3>ğŸ—ºï¸ çµ±åˆãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—</h3>
            <div class="clinic-name" id="clinicName"></div>
            <div class="stats" id="stats"></div>
            <div class="risk-summary" id="riskSummary"></div>
        </div>
        
        <button class="back-btn" onclick="resetApp()">
            â† æ–°ã—ã„åœ°å›³ã‚’ä½œæˆ
        </button>
        
        <button class="save-json-btn" onclick="saveAsJSON()" style="position: fixed; bottom: 80px; right: 20px; background: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; transition: all 0.3s;">
            ğŸ’¾ åœ°å›³ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        </button>
        
        <!-- è‘—ä½œæ¨©è¡¨ç¤º -->
        <div style="position: fixed; top: 190px; left: 10px; background: rgba(255,255,255,0.9); padding: 6px 10px; border-radius: 6px; font-size: 10px; color: #666; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            Â© 2026 ç¦äº•ã€€å¤§æ²»éƒ<br>
            <a href="https://github.com/daichance-med/zaitaku-bcp-hazardmap" target="_blank" style="color: #667eea; text-decoration: none; font-size: 10px;">GitHub</a>
        </div>
    </div>
    
    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆäº‹æ¥­æ‰€æƒ…å ±
        let CLINIC_INFO = {
            name: 'â—¯â—¯è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
            address: 'â—¯â—¯çœŒâ—¯â—¯å¸‚â—¯â—¯åŒº1-2-3',
            lat: 35.6812,
            lng: 139.7671
        };
        
        // ä¸»è¦éƒ½å¸‚ã®å¸‚å¤–å±€ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆåœ¨å®…åŒ»ç™‚ãŒå¤šã„åœ°åŸŸã‚’ä¸­å¿ƒã«100éƒ½å¸‚ï¼‰
        const AREA_CODES = {
            // åŒ—æµ·é“
            'æœ­å¹Œå¸‚': '011', 'å‡½é¤¨å¸‚': '0138', 'æ—­å·å¸‚': '0166', 'é‡§è·¯å¸‚': '0154', 'å¸¯åºƒå¸‚': '0155',
            'åŒ—è¦‹å¸‚': '0157', 'å°æ¨½å¸‚': '0134', 'å®¤è˜­å¸‚': '0143',
            
            // æ±åŒ—
            'é’æ£®å¸‚': '017', 'å¼˜å‰å¸‚': '0172', 'å…«æˆ¸å¸‚': '0178',
            'ç››å²¡å¸‚': '019', 'ä»™å°å¸‚': '022', 'ç§‹ç”°å¸‚': '018', 'å±±å½¢å¸‚': '023', 'ç¦å³¶å¸‚': '024',
            'éƒ¡å±±å¸‚': '024', 'ã„ã‚ãå¸‚': '0246',
            
            // é–¢æ±
            'æ°´æˆ¸å¸‚': '029', 'ã¤ãã°å¸‚': '029', 'å®‡éƒ½å®®å¸‚': '028', 'å‰æ©‹å¸‚': '027', 'é«˜å´å¸‚': '027',
            'å·è¶Šå¸‚': '049', 'å·å£å¸‚': '048', 'æ‰€æ²¢å¸‚': '04', 'è¶Šè°·å¸‚': '048', 'è‰åŠ å¸‚': '048',
            'æ˜¥æ—¥éƒ¨å¸‚': '048', 'ç†Šè°·å¸‚': '048', 'åƒè‘‰å¸‚': '043', 'å¸‚å·å¸‚': '047', 'èˆ¹æ©‹å¸‚': '047',
            'æ¾æˆ¸å¸‚': '047', 'æŸå¸‚': '04', 'å…«åƒä»£å¸‚': '047',
            
            // æ±äº¬23åŒº
            'åƒä»£ç”°åŒº': '03', 'ä¸­å¤®åŒº': '03', 'æ¸¯åŒº': '03', 'æ–°å®¿åŒº': '03', 'æ–‡äº¬åŒº': '03',
            'å°æ±åŒº': '03', 'å¢¨ç”°åŒº': '03', 'æ±Ÿæ±åŒº': '03', 'å“å·åŒº': '03', 'ç›®é»’åŒº': '03',
            'å¤§ç”°åŒº': '03', 'ä¸–ç”°è°·åŒº': '03', 'æ¸‹è°·åŒº': '03', 'ä¸­é‡åŒº': '03', 'æ‰ä¸¦åŒº': '03',
            'è±Šå³¶åŒº': '03', 'åŒ—åŒº': '03', 'è’å·åŒº': '03', 'æ¿æ©‹åŒº': '03', 'ç·´é¦¬åŒº': '03',
            'è¶³ç«‹åŒº': '03', 'è‘›é£¾åŒº': '03', 'æ±Ÿæˆ¸å·åŒº': '03',
            
            // æ±äº¬å¸‚éƒ¨
            'å…«ç‹å­å¸‚': '042', 'ç«‹å·å¸‚': '042', 'æ­¦è”µé‡å¸‚': '0422', 'ä¸‰é·¹å¸‚': '0422',
            'åºœä¸­å¸‚': '042', 'èª¿å¸ƒå¸‚': '042', 'ç”ºç”°å¸‚': '042', 'æ—¥é‡å¸‚': '042',
            
            // ç¥å¥ˆå·
            'æ¨ªæµœå¸‚': '045', 'å·å´å¸‚': '044', 'ç›¸æ¨¡åŸå¸‚': '042', 'æ¨ªé ˆè³€å¸‚': '046',
            'å¹³å¡šå¸‚': '0463', 'éŒå€‰å¸‚': '0467', 'è—¤æ²¢å¸‚': '0466', 'å°ç”°åŸå¸‚': '0465',
            'èŒ…ãƒ¶å´å¸‚': '0467', 'åšæœ¨å¸‚': '046', 'å¤§å’Œå¸‚': '046', 'æµ·è€åå¸‚': '046',
            
            // ä¸­éƒ¨
            'æ–°æ½Ÿå¸‚': '025', 'å¯Œå±±å¸‚': '076', 'é‡‘æ²¢å¸‚': '076', 'ç¦äº•å¸‚': '0776',
            'ç”²åºœå¸‚': '055', 'é•·é‡å¸‚': '026', 'æ¾æœ¬å¸‚': '0263', 'å²é˜œå¸‚': '058',
            'é™å²¡å¸‚': '054', 'æµœæ¾å¸‚': '053', 'æ²¼æ´¥å¸‚': '055', 'å¯Œå£«å¸‚': '0545',
            
            // æ„›çŸ¥
            'åå¤å±‹å¸‚': '052', 'è±Šæ©‹å¸‚': '0532', 'å²¡å´å¸‚': '0564', 'ä¸€å®®å¸‚': '0586',
            'æ˜¥æ—¥äº•å¸‚': '0568', 'è±Šç”°å¸‚': '0565',
            
            // é–¢è¥¿
            'å¤§æ´¥å¸‚': '077', 'äº¬éƒ½å¸‚': '075', 'å®‡æ²»å¸‚': '0774',
            'å¤§é˜ªå¸‚': '06', 'å ºå¸‚': '072', 'è±Šä¸­å¸‚': '06', 'å¹ç”°å¸‚': '06', 'é«˜æ§»å¸‚': '072',
            'æšæ–¹å¸‚': '072', 'èŒ¨æœ¨å¸‚': '072', 'å…«å°¾å¸‚': '072', 'å¯å±‹å·å¸‚': '072',
            'æ±å¤§é˜ªå¸‚': '06',
            'ç¥æˆ¸å¸‚': '078', 'å§«è·¯å¸‚': '079', 'å°¼å´å¸‚': '06', 'è¥¿å®®å¸‚': '0798',
            'æ˜çŸ³å¸‚': '078', 'å¥ˆè‰¯å¸‚': '0742', 'å’Œæ­Œå±±å¸‚': '073',
            
            // ä¸­å›½
            'é³¥å–å¸‚': '0857', 'æ¾æ±Ÿå¸‚': '0852', 'å²¡å±±å¸‚': '086', 'å€‰æ•·å¸‚': '086',
            'åºƒå³¶å¸‚': '082', 'ç¦å±±å¸‚': '084', 'å‘‰å¸‚': '0823', 'å±±å£å¸‚': '083', 'ä¸‹é–¢å¸‚': '083',
            
            // å››å›½
            'å¾³å³¶å¸‚': '088', 'é«˜æ¾å¸‚': '087', 'æ¾å±±å¸‚': '089', 'é«˜çŸ¥å¸‚': '088',
            
            // ä¹å·ãƒ»æ²–ç¸„
            'åŒ—ä¹å·å¸‚': '093', 'ç¦å²¡å¸‚': '092', 'ä¹…ç•™ç±³å¸‚': '0942', 'ä½è³€å¸‚': '0952',
            'é•·å´å¸‚': '095', 'ä½ä¸–ä¿å¸‚': '0956', 'ç†Šæœ¬å¸‚': '096', 'å¤§åˆ†å¸‚': '097',
            'å®®å´å¸‚': '0985', 'é¹¿å…å³¶å¸‚': '099', 'é‚£è¦‡å¸‚': '098'
        };
        
        // ä½æ‰€ã‹ã‚‰å¸‚åŒºç”ºæ‘ã‚’æŠ½å‡º
        function extractCity(address) {
            if (!address) return null;
            
            // éƒ½é“åºœçœŒåã‚’é™¤å»
            address = address.replace(/^.{2,3}[éƒ½é“åºœçœŒ]/, '');
            
            // å¸‚åŒºç”ºæ‘ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
            const patterns = [
                /([^\s]+?[å¸‚åŒºç”ºæ‘])/,
                /([^\s]+?éƒ¡[^\s]+?[ç”ºæ‘])/
            ];
            
            for (let pattern of patterns) {
                const match = address.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            return null;
        }
        
        // å¸‚å¤–å±€ç•ªã‚’è‡ªå‹•è£œå®Œ
        function autoCompleteAreaCode(phone, address) {
            if (!phone || !address) return phone;
            
            // ã™ã§ã«å¸‚å¤–å±€ç•ªãŒã‚ã‚‹å ´åˆï¼ˆ0ã‹ã‚‰å§‹ã¾ã‚‹10-11æ¡ï¼‰
            const cleanPhone = phone.replace(/[-ï¼ãƒ¼\s]/g, '');
            if (cleanPhone.startsWith('0') && cleanPhone.length >= 10) {
                return phone; // ãã®ã¾ã¾è¿”ã™
            }
            
            // å¸‚åŒºç”ºæ‘ã‚’æŠ½å‡º
            const city = extractCity(address);
            if (!city || !AREA_CODES[city]) {
                return phone; // å¸‚å¤–å±€ç•ªãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãã®ã¾ã¾
            }
            
            // å¸‚å¤–å±€ç•ªã‚’è¿½åŠ 
            const areaCode = AREA_CODES[city];
            return { 
                phone: `${areaCode}-${phone}`,
                autoAdded: true,
                city: city,
                areaCode: areaCode
            };
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map = null;
        let mapData = null;
        let geocodingErrors = [];
        let areaCodeAdjustments = []; // å¸‚å¤–å±€ç•ªè‡ªå‹•è¿½åŠ ã®è¨˜éŒ²
        
        // åˆ©ç”¨è¦ç´„ã®åŒæ„å‡¦ç†
        const termsScreen = document.getElementById('termsScreen');
        const agreeCheckbox = document.getElementById('agreeCheckbox');
        const agreeButton = document.getElementById('agreeButton');
        
        agreeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                agreeButton.disabled = false;
                agreeButton.style.background = '#27ae60';
                agreeButton.style.cursor = 'pointer';
            } else {
                agreeButton.disabled = true;
                agreeButton.style.background = '#95a5a6';
                agreeButton.style.cursor = 'not-allowed';
            }
        });
        
        agreeButton.addEventListener('click', function() {
            if (agreeCheckbox.checked) {
                termsScreen.style.display = 'none';
            }
        });
        
        // DOMè¦ç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loader = document.getElementById('loader');
        const status = document.getElementById('status');
        const fileInfo = document.getElementById('fileInfo');
        const uploadScreen = document.getElementById('uploadScreen');
        const mapScreen = document.getElementById('mapScreen');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressLabel = document.getElementById('progressLabel');
        const progressStatus = document.getElementById('progressStatus');
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFile(file) {
            const fileName = file.name.toLowerCase();
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼åˆ¤å®š
            if (fileName.endsWith('.json')) {
                // JSONï¼ˆä¿å­˜ã—ãŸBCPåœ°å›³ï¼‰
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `
                    <strong>ğŸ’¾ ${file.name}</strong><br>
                    <span style="color: #7f8c8d; font-size: 0.9em;">ä¿å­˜ã—ãŸBCPåœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                `;
                processJSON(file);
                
            } else if (fileName.endsWith('.csv')) {
                // CSVï¼ˆé›»å­ã‚«ãƒ«ãƒ†ã‹ã‚‰å‡ºåŠ›ï¼‰
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `
                    <strong>ğŸ“„ ${file.name}</strong><br>
                    <span style="color: #7f8c8d; font-size: 0.9em;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›ä¸­...</span>
                `;
                processCSV(file);
                
            } else if (fileName.match(/\.(xlsx|xls)$/)) {
                // Excel
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `
                    <strong>ğŸ“„ ${file.name}</strong><br>
                    <span style="color: #7f8c8d; font-size: 0.9em;">${(file.size / 1024).toFixed(1)} KB</span>
                `;
                processExcel(file);
                
            } else {
                showStatus('å¯¾å¿œã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: Excel (.xlsx, .xls) / CSV (.csv) / JSON (.json)', 'error');
                return;
            }
        }
        
        // Excelå‡¦ç†
        async function processExcel(file) {
            loader.style.display = 'block';
            status.style.display = 'none';
            geocodingErrors = [];
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Sheet2ã‹ã‚‰ã‚¯ãƒªãƒ‹ãƒƒã‚¯æƒ…å ±ã‚’èª­ã¿å–ã‚‹
                    if (workbook.SheetNames.length > 1) {
                        const clinicSheet = workbook.Sheets[workbook.SheetNames[1]];
                        const clinicData = XLSX.utils.sheet_to_json(clinicSheet, { header: 1 });
                        
                        // ã‚¯ãƒªãƒ‹ãƒƒã‚¯æƒ…å ±ã‚’æŠ½å‡º
                        const clinicInfo = {};
                        clinicData.forEach(row => {
                            if (row[0] && row[1]) {
                                clinicInfo[row[0]] = row[1];
                            }
                        });
                        
                        // äº‹æ¥­æ‰€åï¼ˆæŸ”è»Ÿãªåˆ—åèªè­˜ï¼‰
                        const nameKeys = ['äº‹æ¥­æ‰€å', 'ã‚¯ãƒªãƒ‹ãƒƒã‚¯å', 'æ–½è¨­å', 'åç§°'];
                        for (let key of nameKeys) {
                            if (clinicInfo[key]) {
                                CLINIC_INFO.name = clinicInfo[key];
                                break;
                            }
                        }
                        
                        if (clinicInfo['ä½æ‰€']) {
                            CLINIC_INFO.address = clinicInfo['ä½æ‰€'];
                        }
                        if (clinicInfo['ç·¯åº¦'] && clinicInfo['çµŒåº¦']) {
                            CLINIC_INFO.lat = parseFloat(clinicInfo['ç·¯åº¦']);
                            CLINIC_INFO.lng = parseFloat(clinicInfo['çµŒåº¦']);
                        } else if (clinicInfo['ä½æ‰€']) {
                            // ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã®ä½æ‰€ã‹ã‚‰åº§æ¨™å–å¾—
                            const coords = await geocodeAddress(clinicInfo['ä½æ‰€']);
                            if (coords) {
                                CLINIC_INFO.lat = coords.lat;
                                CLINIC_INFO.lng = coords.lng;
                            }
                        }
                    }
                    
                    // æ‚£è€…ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        throw new Error('Excelãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    }
                    
                    // å¿…é ˆåˆ—ã®ç¢ºèªï¼ˆæŸ”è»Ÿãªåˆ—åèªè­˜ï¼‰
                    const firstRow = jsonData[0];
                    
                    // åˆ—åã‚’æ¢ã™
                    const nameCol = findColumn(jsonData, ['æ‚£è€…æ°å', 'æ‚£è€…åå‰', 'æ°å', 'åå‰', 'name']);
                    const addressCol = findColumn(jsonData, ['ä½æ‰€', 'è‡ªå®…ä½æ‰€', 'æ‚£è€…ä½æ‰€', 'address']);
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã«å®Ÿéš›ã®åˆ—åã‚’å–å¾—
                    const actualColumns = Object.keys(firstRow).join('ã€');
                    
                    if (!nameCol) {
                        throw new Error(
                            `å¿…é ˆåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: æ‚£è€…æ°å\n\n` +
                            `è¦‹ã¤ã‹ã£ãŸåˆ—: ${actualColumns}\n\n` +
                            `ğŸ’¡ ä½¿ç”¨å¯èƒ½ãªåˆ—å:\n` +
                            `æ‚£è€…æ°åã€æ‚£è€…åå‰ã€æ°åã€åå‰ã€name`
                        );
                    }
                    
                    if (!addressCol) {
                        throw new Error(
                            `å¿…é ˆåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ä½æ‰€\n\n` +
                            `è¦‹ã¤ã‹ã£ãŸåˆ—: ${actualColumns}\n\n` +
                            `ğŸ’¡ ä½¿ç”¨å¯èƒ½ãªåˆ—å:\n` +
                            `ä½æ‰€ã€è‡ªå®…ä½æ‰€ã€æ‚£è€…ä½æ‰€ã€address`
                        );
                    }
                    
                    loader.style.display = 'none';
                    
                    // åº§æ¨™å¤‰æ›ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
                    const needsGeocoding = jsonData.some(row => !row.lat || !row.lon);
                    
                    if (needsGeocoding) {
                        showStatus('åº§æ¨™å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
                        await processWithGeocoding(jsonData);
                    } else {
                        // åº§æ¨™ãŒã™ã§ã«ã‚ã‚‹å ´åˆ
                        const markers = processPatientData(jsonData);
                        showMap(markers);
                    }
                    
                } catch (error) {
                    loader.style.display = 'none';
                    progressContainer.style.display = 'none';
                    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                    console.error(error);
                }
            };
            
            reader.onerror = function() {
                loader.style.display = 'none';
                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // åº§æ¨™å¤‰æ›å‡¦ç†
        async function processWithGeocoding(data) {
            progressContainer.style.display = 'block';
            
            // åˆ—åã‚’æ¢ã™
            const nameCol = findColumn(data, ['æ‚£è€…æ°å', 'æ‚£è€…åå‰', 'æ°å', 'åå‰', 'name']);
            const addressCol = findColumn(data, ['ä½æ‰€', 'è‡ªå®…ä½æ‰€', 'æ‚£è€…ä½æ‰€', 'address']);
            let latCol = findColumn(data, ['lat', 'latitude', 'ç·¯åº¦']);
            let lonCol = findColumn(data, ['lon', 'lng', 'longitude', 'çµŒåº¦']);
            
            // åº§æ¨™åˆ—ãŒãªã„å ´åˆã¯è¿½åŠ 
            if (!latCol) {
                latCol = 'lat';
                data.forEach(row => row[latCol] = null);
            }
            if (!lonCol) {
                lonCol = 'lng';
                data.forEach(row => row[lonCol] = null);
            }
            
            const total = data.length;
            let processed = 0;
            let success = 0;
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                
                // åº§æ¨™ãŒãªã„å ´åˆã®ã¿å¤‰æ›
                if (!row[latCol] || !row[lonCol]) {
                    const address = row[addressCol] || '';
                    
                    if (address) {
                        updateProgress(processed, total, `${row[nameCol] || ''}ã®ä½æ‰€ã‚’å¤‰æ›ä¸­...`);
                        
                        const coords = await geocodeAddress(address);
                        
                        if (coords) {
                            row[latCol] = coords.lat;
                            row[lonCol] = coords.lng;
                            success++;
                        } else {
                            geocodingErrors.push({
                                name: row[nameCol] || 'ä¸æ˜',
                                address: address,
                                reason: 'åº§æ¨™å–å¾—å¤±æ•—'
                            });
                        }
                        
                        // APIåˆ¶é™å¯¾ç­–ï¼šå°‘ã—å¾…ã¤
                        await sleep(500);
                    } else {
                        geocodingErrors.push({
                            name: row[nameCol] || 'ä¸æ˜',
                            address: 'ä½æ‰€ãªã—',
                            reason: 'ä½æ‰€ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“'
                        });
                    }
                } else {
                    success++;
                }
                
                processed++;
                updateProgress(processed, total);
            }
            
            progressContainer.style.display = 'none';
            
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            if (geocodingErrors.length > 0) {
                let errorHTML = `âš ï¸ ä»¥ä¸‹ã®${geocodingErrors.length}ä»¶ã¯åº§æ¨™å¤‰æ›ã§ãã¾ã›ã‚“ã§ã—ãŸï¼š<br>`;
                errorHTML += `<div class="error-list">`;
                geocodingErrors.forEach(err => {
                    errorHTML += `<div class="error-list-item">ãƒ»${err.name}: ${err.address} (${err.reason})</div>`;
                });
                errorHTML += `</div>`;
                errorHTML += `<br>å¤‰æ›æˆåŠŸ: ${success}/${total}å`;
                
                showStatus(errorHTML, 'warning');
            } else {
                showStatus(`âœ… å…¨${total}åã®åº§æ¨™å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸ`, 'success');
            }
            
            // åœ°å›³è¡¨ç¤ºï¼ˆå°‘ã—å¾…ã£ã¦ã‹ã‚‰ï¼‰
            setTimeout(() => {
                try {
                    const markers = processPatientData(data);
                    console.log('Markers created:', markers.length);
                    if (markers && markers.length > 0) {
                        showMap(markers);
                    } else {
                        showStatus('ã‚¨ãƒ©ãƒ¼: åœ°å›³è¡¨ç¤ºç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
                    }
                } catch (error) {
                    console.error('Map display error:', error);
                    showStatus('ã‚¨ãƒ©ãƒ¼: åœ°å›³è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ - ' + error.message, 'error');
                }
            }, 2000);
        }
        
        // ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—
        async function geocodeAddress(address) {
            try {
                // å›½åœŸåœ°ç†é™¢ ä½æ‰€æ¤œç´¢API
                const url = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data.length > 0 && data[0].geometry && data[0].geometry.coordinates) {
                    return {
                        lng: data[0].geometry.coordinates[0],
                        lat: data[0].geometry.coordinates[1]
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        function updateProgress(current, total, message = '') {
            const percent = Math.round((current / total) * 100);
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            progressPercent.textContent = percent + '%';
            
            if (message) {
                progressStatus.textContent = message;
            } else {
                progressStatus.textContent = `${current} / ${total} å®Œäº†`;
            }
        }
        
        // ã‚¹ãƒªãƒ¼ãƒ—é–¢æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // æŸ”è»Ÿãªåˆ—åèªè­˜ï¼ˆå®Œå…¨ä¸€è‡´å„ªå…ˆï¼‰
        function findColumn(data, possibleNames) {
            const columns = Object.keys(data[0] || {});
            
            // ç¬¬1ãƒ‘ã‚¹: å®Œå…¨ä¸€è‡´ã‚’æ¢ã™
            for (let possible of possibleNames) {
                const pattern = possible.toLowerCase().replace(/\s/g, '');
                const found = columns.find(col => {
                    const normalized = col.toLowerCase().replace(/\s/g, '');
                    return normalized === pattern;
                });
                if (found) return found;
            }
            
            // ç¬¬2ãƒ‘ã‚¹: éƒ¨åˆ†ä¸€è‡´ã‚’æ¢ã™
            for (let possible of possibleNames) {
                const pattern = possible.toLowerCase().replace(/\s/g, '');
                const found = columns.find(col => {
                    const normalized = col.toLowerCase().replace(/\s/g, '');
                    return normalized.includes(pattern) || pattern.includes(normalized);
                });
                if (found) return found;
            }
            
            return null;
        }
        
        // æ‚£è€…ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆæŸ”è»Ÿãªåˆ—åå¯¾å¿œç‰ˆï¼‰
        function processPatientData(data) {
            // åˆ—åã‚’æ¢ã™
            const nameCol = findColumn(data, ['æ‚£è€…æ°å', 'æ‚£è€…åå‰', 'æ°å', 'åå‰', 'name']);
            const addressCol = findColumn(data, ['ä½æ‰€', 'è‡ªå®…ä½æ‰€', 'æ‚£è€…ä½æ‰€', 'address']);
            const phoneCol = findColumn(data, ['è‡ªå®…é›»è©±ç•ªå·', 'é›»è©±ç•ªå·', 'TEL', 'é›»è©±', 'phone']);
            const riskCol = findColumn(data, ['ãƒªã‚¹ã‚¯åˆ†é¡', 'ãƒªã‚¹ã‚¯', 'å±é™ºåº¦', 'risk']);
            const notesCol = findColumn(data, ['å‚™è€ƒ', 'ãƒ¡ãƒ¢', 'note', 'notes']);
            const idCol = findColumn(data, ['æ‚£è€…ç•ªå·', 'ç•ªå·', 'ID', 'id']);
            const latCol = findColumn(data, ['lat', 'latitude', 'ç·¯åº¦']);
            const lonCol = findColumn(data, ['lon', 'lng', 'longitude', 'çµŒåº¦']);
            
            console.log('æ¤œå‡ºã•ã‚ŒãŸåˆ—å:', {
                nameCol, addressCol, phoneCol, riskCol, notesCol, idCol, latCol, lonCol
            });
            
            const locationGroups = {};
            
            data.forEach(row => {
                // åº§æ¨™ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                const lat = parseFloat(row[latCol]);
                const lng = parseFloat(row[lonCol]);
                
                if (isNaN(lat) || isNaN(lng)) {
                    console.log('Skipping row (no valid coordinates):', row);
                    return;
                }
                
                // ä½æ‰€ï¼ˆå¾Œã§å¸‚å¤–å±€ç•ªè£œå®Œã«ä½¿ç”¨ï¼‰
                const address = row[addressCol] || '';
                
                // é›»è©±ç•ªå·å‡¦ç†ï¼ˆè¤‡æ•°åˆ—å¯¾å¿œ + å¸‚å¤–å±€ç•ªè‡ªå‹•è£œå®Œï¼‰
                let phones = []; // è¤‡æ•°é›»è©±ç•ªå·ã‚’é…åˆ—ã§ç®¡ç†
                
                // é›»è©±ç•ªå·ï¼ˆå›ºå®šé›»è©±ï¼‰
                if (phoneCol && row[phoneCol]) {
                    let phoneRaw = String(row[phoneCol]).trim();
                    if (phoneRaw && phoneRaw !== 'nan') {
                        const result = autoCompleteAreaCode(phoneRaw, address);
                        let phone = '';
                        let skipFormatting = false;
                        
                        if (typeof result === 'object' && result.autoAdded) {
                            phone = result.phone;
                            skipFormatting = true; // å¸‚å¤–å±€ç•ªè¿½åŠ æ¸ˆã¿ãªã®ã§ãƒã‚¤ãƒ•ãƒ³æ•´å½¢ã‚¹ã‚­ãƒƒãƒ—
                            areaCodeAdjustments.push({
                                name: row[nameCol] || 'ä¸æ˜',
                                original: phoneRaw,
                                adjusted: phone,
                                city: result.city,
                                areaCode: result.areaCode
                            });
                        } else {
                            phone = typeof result === 'object' ? result.phone : result;
                        }
                        
                        // ãƒã‚¤ãƒ•ãƒ³æ•´å½¢ï¼ˆå¸‚å¤–å±€ç•ªè‡ªå‹•è¿½åŠ ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                        if (!skipFormatting) {
                            phone = phone.replace(/[-ï¼ãƒ¼\s]/g, '');
                            if (phone.length === 10) {
                                phone = `${phone.slice(0,4)}-${phone.slice(4,6)}-${phone.slice(6)}`;
                            } else if (phone.length === 11) {
                                phone = `${phone.slice(0,3)}-${phone.slice(3,7)}-${phone.slice(7)}`;
                            }
                        }
                        
                        if (phone) {
                            phones.push({ type: 'å›ºå®šé›»è©±', number: phone });
                        }
                    }
                }
                
                // æºå¸¯ç•ªå·
                const mobileCol = findColumn(data, ['ãã®ä»–ã®é›»è©±ç•ªå·', 'æºå¸¯ç•ªå·', 'æºå¸¯é›»è©±', 'æºå¸¯', 'mobile', 'cell']);
                if (mobileCol && row[mobileCol]) {
                    let phoneRaw = String(row[mobileCol]).trim();
                    if (phoneRaw && phoneRaw !== 'nan') {
                        const result = autoCompleteAreaCode(phoneRaw, address);
                        let phone = typeof result === 'object' ? result.phone : result;
                        let skipFormatting = (typeof result === 'object' && result.autoAdded);
                        
                        // ãƒã‚¤ãƒ•ãƒ³æ•´å½¢ï¼ˆå¸‚å¤–å±€ç•ªè‡ªå‹•è¿½åŠ ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                        if (!skipFormatting) {
                            phone = phone.replace(/[-ï¼ãƒ¼\s]/g, '');
                            if (phone.length === 10) {
                                phone = `${phone.slice(0,4)}-${phone.slice(4,6)}-${phone.slice(6)}`;
                            } else if (phone.length === 11) {
                                phone = `${phone.slice(0,3)}-${phone.slice(3,7)}-${phone.slice(7)}`;
                            }
                        }
                        
                        if (phone) {
                            phones.push({ type: 'æºå¸¯é›»è©±', number: phone });
                        }
                    }
                }
                
                // é€£çµ¡å…ˆé›»è©±ç•ªå·
                const contactPhoneCol = findColumn(data, ['é€£çµ¡å…ˆé›»è©±ç•ªå·', 'ç·Šæ€¥é€£çµ¡å…ˆ', 'é€£çµ¡å…ˆ']);
                if (contactPhoneCol && row[contactPhoneCol]) {
                    let phoneRaw = String(row[contactPhoneCol]).trim();
                    if (phoneRaw && phoneRaw !== 'nan') {
                        const result = autoCompleteAreaCode(phoneRaw, address);
                        let phone = typeof result === 'object' ? result.phone : result;
                        let skipFormatting = (typeof result === 'object' && result.autoAdded);
                        
                        // ãƒã‚¤ãƒ•ãƒ³æ•´å½¢ï¼ˆå¸‚å¤–å±€ç•ªè‡ªå‹•è¿½åŠ ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                        if (!skipFormatting) {
                            phone = phone.replace(/[-ï¼ãƒ¼\s]/g, '');
                            if (phone.length === 10) {
                                phone = `${phone.slice(0,3)}-${phone.slice(3,6)}-${phone.slice(6)}`;
                            } else if (phone.length === 11) {
                                phone = `${phone.slice(0,3)}-${phone.slice(3,7)}-${phone.slice(7)}`;
                            }
                        }
                        
                        if (phone) {
                            phones.push({ type: 'é€£çµ¡å…ˆ', number: phone });
                        }
                    }
                }
                
                // ãƒªã‚¹ã‚¯åˆ†é¡ã®æ­£è¦åŒ–é–¢æ•°
                function normalizeRiskLevel(value) {
                    if (!value) return 'ä½';
                    
                    const str = String(value).trim().toLowerCase();
                    
                    // é«˜ãƒªã‚¹ã‚¯
                    if (str.match(/^(é«˜|é‡|èµ¤|red|h|3|â˜…â˜…â˜…|danger|high)$/)) {
                        return 'é«˜';
                    }
                    
                    // ä¸­ãƒªã‚¹ã‚¯
                    if (str.match(/^(ä¸­|é»„|yellow|m|2|â˜…â˜…|warning|medium|mid)$/)) {
                        return 'ä¸­';
                    }
                    
                    // ä½ãƒªã‚¹ã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                    return 'ä½';
                }
                
                // ãƒªã‚¹ã‚¯åˆ†é¡
                let riskLevel = 'ä½';
                if (riskCol && row[riskCol]) {
                    riskLevel = normalizeRiskLevel(row[riskCol]);
                }
                
                // å‚™è€ƒ
                let notes = '';
                if (notesCol && row[notesCol]) {
                    notes = String(row[notesCol]).trim();
                    if (notes === 'undefined' || notes === 'null') {
                        notes = '';
                    }
                }
                
                // æ‚£è€…ç•ªå·
                const patientId = idCol && row[idCol] ? row[idCol] : 0;
                
                // åº§æ¨™ã‚’ä¸¸ã‚ã¦ã‚­ãƒ¼ã«ã™ã‚‹
                const locationKey = `${lat.toFixed(6)},${lng.toFixed(6)}`;
                
                if (!locationGroups[locationKey]) {
                    locationGroups[locationKey] = {
                        lat,
                        lng,
                        patients: []
                    };
                }
                
                locationGroups[locationKey].patients.push({
                    id: patientId,
                    name: String(row[nameCol] || '').trim(),
                    address: String(address).trim(),
                    phones: phones, // è¤‡æ•°é›»è©±ç•ªå·
                    risk_level: riskLevel,
                    notes
                });
            });
            
            // ãƒãƒ¼ã‚«ãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆ
            const markers = Object.values(locationGroups).map(group => {
                const riskPriority = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
                const maxRisk = group.patients.reduce((max, p) => {
                    return riskPriority[p.risk_level] > riskPriority[max] ? p.risk_level : max;
                }, 'ä½');
                
                return {
                    lat: group.lat,
                    lng: group.lng,
                    patients: group.patients,
                    group_risk: maxRisk,
                    count: group.patients.length,
                    address: group.patients[0].address
                };
            });
            
            return markers;
        }
        
        // åœ°å›³è¡¨ç¤ºï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰
        function showMap(markers) {
            // çµ±è¨ˆæƒ…å ±
            const allPatients = markers.flatMap(m => m.patients);
            const stats = {
                total_patients: allPatients.length,
                total_markers: markers.length,
                high_risk: allPatients.filter(p => p.risk_level === 'é«˜').length,
                mid_risk: allPatients.filter(p => p.risk_level === 'ä¸­').length,
                low_risk: allPatients.filter(p => p.risk_level === 'ä½').length,
                with_phone: allPatients.filter(p => p.phones && p.phones.length > 0).length
            };
            
            // å¸‚å¤–å±€ç•ªè‡ªå‹•è¿½åŠ ã®é€šçŸ¥
            if (areaCodeAdjustments.length > 0) {
                let message = `ğŸ“ ${areaCodeAdjustments.length}ä»¶ã®é›»è©±ç•ªå·ã«å¸‚å¤–å±€ç•ªã‚’è‡ªå‹•è¿½åŠ ã—ã¾ã—ãŸï¼š<br><br>`;
                message += '<div class="error-list" style="max-height: 200px;">';
                areaCodeAdjustments.forEach(adj => {
                    message += `<div class="error-list-item">`;
                    message += `ãƒ»${adj.name}: ${adj.original} â†’ <strong>${adj.adjusted}</strong> `;
                    message += `<span style="color: #667eea;">(${adj.city}: ${adj.areaCode})</span>`;
                    message += `</div>`;
                });
                message += '</div>';
                message += '<br>âœ… å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                
                showStatus(message, 'info');
                
                // 3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜ï¼ˆåœ°å›³è¡¨ç¤ºç”¨ï¼‰
            mapData = { markers, stats };
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            uploadScreen.style.display = 'none';
            mapScreen.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
            document.getElementById('clinicName').textContent = `ğŸ“ ${CLINIC_INFO.name}`;
            document.getElementById('stats').innerHTML = `
                ç™»éŒ²æ‚£è€…: <strong>${stats.total_patients}å</strong><br>
                é›»è©±ç•ªå·: <strong>${stats.with_phone}å</strong>
            `;
            document.getElementById('riskSummary').innerHTML = `
                <div class="risk-item risk-high">ğŸ”´ é«˜<br><strong>${stats.high_risk}</strong></div>
                <div class="risk-item risk-mid">ğŸŸ¡ ä¸­<br><strong>${stats.mid_risk}</strong></div>
                <div class="risk-item risk-low">ğŸŸ¢ ä½<br><strong>${stats.low_risk}</strong></div>
            `;
            
            // ã€é‡è¦ã€‘ãƒ¡ãƒ¢ãƒªã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            jsonData = null;
            workbook = null;
            data = null;
            
            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã‚’è¡¨ç¤º
            setTimeout(() => {
                showSecurityWarning();
            }, 2000);
            
            // åœ°å›³åˆæœŸåŒ–
            if (map) {
                map.remove();
            }
            
            map = L.map('map', {
                center: [CLINIC_INFO.lat, CLINIC_INFO.lng],
                zoom: 14,
                zoomControl: true
            });
            
            // èƒŒæ™¯åœ°å›³
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
            
            // ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            const floodLayer = L.tileLayer(
                'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png',
                { attribution: 'å›½åœŸäº¤é€šçœ', opacity: 0.6, maxZoom: 20, maxNativeZoom: 17 }
            ).addTo(map);
            
            const doshaLayer = L.tileLayer(
                'https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png',
                { attribution: 'å›½åœŸäº¤é€šçœ', opacity: 0.6, maxZoom: 20, maxNativeZoom: 17 }
            ).addTo(map);
            
            const tsunamiLayer = L.tileLayer(
                'https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png',
                { attribution: 'å›½åœŸäº¤é€šçœ', opacity: 0.6, maxZoom: 20, maxNativeZoom: 17 }
            ).addTo(map);
            
            // äº‹æ¥­æ‰€ãƒãƒ¼ã‚«ãƒ¼
            const clinicMarker = L.marker([CLINIC_INFO.lat, CLINIC_INFO.lng], {
                icon: L.divIcon({
                    className: 'clinic-icon',
                    html: '<div style="font-size: 28px; filter: grayscale(100%) brightness(0%);">â­</div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            }).addTo(map);
            
            clinicMarker.bindPopup(`
                <div style="text-align: center; padding: 10px;">
                    <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">
                        ğŸ¥ ${CLINIC_INFO.name}
                    </div>
                    <div style="color: #7f8c8d; font-size: 0.9em;">${CLINIC_INFO.address}</div>
                </div>
            `);
            
            // æ‚£è€…ãƒãƒ¼ã‚«ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
            const patientGroup = L.featureGroup();
            
            // æ‚£è€…ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
            markers.forEach(marker => {
                const color = marker.group_risk === 'é«˜' ? '#ff0000' : 
                             marker.group_risk === 'ä¸­' ? '#ffaa00' : '#00cc00';
                
                const radius = marker.count === 1 ? 8 : Math.min(8 + marker.count * 0.5, 16);
                
                const circleMarker = L.circleMarker([marker.lat, marker.lng], {
                    radius: radius,
                    fillColor: color,
                    color: '#000',
                    weight: 2,
                    opacity: 1.0,
                    fillOpacity: 0.85
                });
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½œæˆ
                let popupHTML = '<div class="patient-popup">';
                popupHTML += `<div class="address">${marker.address}</div>`;
                
                if (marker.count > 1) {
                    popupHTML += `<div class="patient-count-badge">ğŸ‘¥ å…¥å±…è€… ${marker.count}å</div>`;
                }
                
                marker.patients.forEach((patient, index) => {
                    if (index > 0) {
                        popupHTML += '<hr style="margin: 12px 0; border: none; border-top: 1px solid #ddd;">';
                    }
                    
                    const riskClass = patient.risk_level === 'é«˜' ? 'high' : 
                                     patient.risk_level === 'ä¸­' ? 'mid' : 'low';
                    const riskLabel = patient.risk_level === 'é«˜' ? 'ğŸ”´ æœ€å„ªå…ˆ' : 
                                     patient.risk_level === 'ä¸­' ? 'ğŸŸ¡ è¦æ³¨æ„' : 'ğŸŸ¢ é€šå¸¸';
                    
                    popupHTML += `<div class="risk-badge ${riskClass}">${riskLabel}</div>`;
                    
                    // æ‚£è€…ç•ªå·ã¨æ°åã‚’è¡¨ç¤º
                    if (patient.id) {
                        popupHTML += `<div class="name"><strong>ID:${patient.id}</strong> ${patient.name}</div>`;
                    } else {
                        popupHTML += `<div class="name">${patient.name}</div>`;
                    }
                    
                    // ä½æ‰€ã‚’è¡¨ç¤ºï¼ˆé‡è¦ï¼ï¼‰
                    popupHTML += `<div class="address">${patient.address}</div>`;
                    
                    if (patient.notes) {
                        popupHTML += `
                            <div class="notes">
                                <div class="notes-label">âš ï¸ å‚™è€ƒ</div>
                                <div>${patient.notes}</div>
                            </div>
                        `;
                    }
                    
                    // é›»è©±ç•ªå·ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
                    if (patient.phones && patient.phones.length > 0) {
                        popupHTML += `<div class="phone-section">`;
                        popupHTML += `<div class="phone-label">ğŸ“ é›»è©±ç•ªå·</div>`;
                        
                        patient.phones.forEach((phoneData, phoneIndex) => {
                            popupHTML += `
                                <div style="margin-bottom: 10px;">
                                    <div style="font-size: 0.85em; color: #7f8c8d; margin-bottom: 3px;">${phoneData.type}</div>
                                    <div class="phone-number has-phone">${phoneData.number}</div>
                                    <a href="tel:${phoneData.number.replace(/-/g, '')}" class="call-button" style="margin-top: 5px;">
                                        ğŸ“± ${phoneData.number}ã«ç™ºä¿¡
                                    </a>
                                </div>
                            `;
                        });
                        
                        popupHTML += `</div>`;
                    } else {
                        popupHTML += `
                            <div class="phone-section">
                                <div class="phone-label">ğŸ“ é›»è©±ç•ªå·</div>
                                <div class="phone-number no-phone">æœªç™»éŒ²</div>
                            </div>
                        `;
                    }
                });
                
                popupHTML += '</div>';
                
                circleMarker.bindPopup(popupHTML, {
                    maxWidth: 400,
                    maxHeight: 450
                });
                
                circleMarker.addTo(patientGroup);
            });
            
            patientGroup.addTo(map);
            
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            L.control.layers({}, {
                'æ´ªæ°´ï¼ˆæµ¸æ°´æ·±ï¼‰': floodLayer,
                'åœŸç ‚ç½å®³è­¦æˆ’åŒºåŸŸ': doshaLayer,
                'æ´¥æ³¢æµ¸æ°´æƒ³å®š': tsunamiLayer,
                'æ‚£è€…ãƒãƒ¼ã‚«ãƒ¼': patientGroup,
                'äº‹æ¥­æ‰€': clinicMarker
            }, {
                position: 'topright',
                collapsed: false
            }).addTo(map);
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            status.className = 'status ' + type;
            status.innerHTML = message;
            status.style.display = 'block';
        }
        
        // ã‚¢ãƒ—ãƒªãƒªã‚»ãƒƒãƒˆ
        function resetApp() {
            if (confirm('æ–°ã—ã„åœ°å›³ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®åœ°å›³ã¯æ¶ˆãˆã¾ã™ã€‚')) {
                mapScreen.style.display = 'none';
                uploadScreen.style.display = 'flex';
                document.body.style.overflow = 'auto';
                fileInfo.style.display = 'none';
                status.style.display = 'none';
                progressContainer.style.display = 'none';
                fileInput.value = '';
                mapData = null;
                geocodingErrors = [];
                areaCodeAdjustments = [];
                
                // äº‹æ¥­æ‰€æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
                CLINIC_INFO = {
                    name: 'â—¯â—¯è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
                    address: 'â—¯â—¯çœŒâ—¯â—¯å¸‚â—¯â—¯åŒº1-2-3',
                    lat: 35.6812,
                    lng: 139.7671
                };
                
                if (map) {
                    map.remove();
                    map = null;
                }
            }
        }
        
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã‚’è¡¨ç¤º
        function showSecurityWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff3cd;
                border: 2px solid #ffc107;
                border-radius: 10px;
                padding: 20px 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                max-width: 400px;
                z-index: 9999;
                animation: slideIn 0.5s ease-out;
            `;
            
            warningDiv.innerHTML = `
                <div style="display: flex; align-items: start;">
                    <div style="font-size: 30px; margin-right: 15px;">ğŸ”’</div>
                    <div>
                        <h3 style="margin: 0 0 10px 0; color: #856404; font-size: 16px;">æ‚£è€…æƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦</h3>
                        <p style="margin: 0 0 10px 0; color: #856404; font-size: 14px; line-height: 1.6;">
                            ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯<strong>å®‰å…¨ãªå ´æ‰€ã§ä¿ç®¡</strong>ã—ã¦ãã ã•ã„ã€‚<br>
                            åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’JSONä¿å­˜ã—ãŸå ´åˆã€å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
                        </p>
                        <button onclick="showDeleteInstructions()" style="
                            background: #ffc107;
                            color: #000;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-weight: bold;
                            font-size: 13px;
                            margin-right: 10px;
                        ">ç®¡ç†æ–¹æ³•ã‚’è¡¨ç¤º</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 13px;
                        ">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(warningDiv);
            
            // 30ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
            setTimeout(() => {
                if (warningDiv.parentElement) {
                    warningDiv.style.animation = 'slideOut 0.5s ease-in';
                    setTimeout(() => warningDiv.remove(), 500);
                }
            }, 30000);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†æ–¹æ³•ã‚’è¡¨ç¤º
        function showDeleteInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                ">
                    <h2 style="color: #3498db; margin-top: 0;">ğŸ”’ æ‚£è€…ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†æ–¹æ³•</h2>
                    
                    <h3 style="color: #2c3e50; font-size: 16px;">ã€æ¨å¥¨ï¼šå®‰å…¨ãªå ´æ‰€ã§ä¿ç®¡ã€‘</h3>
                    <ul style="line-height: 1.8; color: #34495e;">
                        <li><strong>æš—å·åŒ–USBãƒ¡ãƒ¢ãƒª</strong>ã«ä¿å­˜</li>
                        <li><strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãZIP</strong>ã§åœ§ç¸®</li>
                        <li><strong>æ–½éŒ ã§ãã‚‹å ´æ‰€</strong>ã«ä¿ç®¡</li>
                        <li>å®šæœŸçš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹</li>
                    </ul>
                    
                    <h3 style="color: #2c3e50; font-size: 16px;">ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šJSONä¿å­˜å¾Œã®å‰Šé™¤ã€‘</h3>
                    <p style="color: #34495e; font-size: 14px;">
                        åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’ã€ŒğŸ’¾ åœ°å›³ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã€ã§JSONå½¢å¼ã§ä¿å­˜ã—ãŸå ´åˆã€<br>
                        å…ƒã®Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
                    </p>
                    
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; color: #3498db; font-weight: bold;">å‰Šé™¤æ‰‹é †ã‚’è¡¨ç¤º</summary>
                        <div style="margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <h4 style="color: #2c3e50; font-size: 14px; margin-top: 0;">Windows</h4>
                            <ol style="font-size: 13px; line-height: 1.6; color: #34495e;">
                                <li>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œå‰Šé™¤ã€</li>
                                <li><strong>ã‚´ãƒŸç®±ã‚’ç©ºã«ã™ã‚‹</strong></li>
                            </ol>
                            
                            <h4 style="color: #2c3e50; font-size: 14px;">Mac</h4>
                            <ol style="font-size: 13px; line-height: 1.6; color: #34495e;">
                                <li>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œã‚´ãƒŸç®±ã«å…¥ã‚Œã‚‹ã€</li>
                                <li><strong>ã‚´ãƒŸç®±ã‚’ç©ºã«ã™ã‚‹</strong></li>
                            </ol>
                        </div>
                    </details>
                    
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; margin-top: 20px; border-left: 4px solid #27ae60;">
                        <strong style="color: #2e7d32;">ğŸ’¡ ãŠã™ã™ã‚é‹ç”¨</strong><br>
                        <span style="color: #2e7d32; font-size: 14px;">
                        æœˆ1å›ï¼šExcelæ›´æ–° â†’ åœ°å›³ä½œæˆ â†’ JSONä¿å­˜<br>
                        ç½å®³æ™‚ï¼šJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å³åº§ã«ä½¿ç”¨
                        </span>
                    </div>
                    
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        width: 100%;
                        padding: 12px;
                        margin-top: 20px;
                        background: #27ae60;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                    ">ç†è§£ã—ã¾ã—ãŸ</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // ====================
        // JSON/CSVå‡¦ç†æ©Ÿèƒ½
        // ====================
        
        // çµ±è¨ˆè¨ˆç®—
        function calculateStats(markers) {
            return {
                total_patients: markers.length,
                high_risk: markers.filter(m => m.risk === 'é«˜').length,
                mid_risk: markers.filter(m => m.risk === 'ä¸­').length,
                low_risk: markers.filter(m => m.risk === 'ä½').length,
                with_phone: markers.filter(m => m.phone || m.mobile || m.contact).length
            };
        }
        
        // ãƒ•ãƒ©ãƒƒãƒˆãªæ‚£è€…é…åˆ—ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹é–¢æ•°
        function groupPatientsByLocation(patients) {
            const locationGroups = {};
            
            patients.forEach(patient => {
                // åº§æ¨™ã‚’ä¸¸ã‚ã¦ã‚­ãƒ¼ã«ã™ã‚‹
                const locationKey = `${patient.lat.toFixed(6)},${patient.lng.toFixed(6)}`;
                
                if (!locationGroups[locationKey]) {
                    locationGroups[locationKey] = {
                        lat: patient.lat,
                        lng: patient.lng,
                        patients: []
                    };
                }
                
                // é›»è©±ç•ªå·ã‚’é…åˆ—å½¢å¼ã«å¤‰æ›
                const phones = [];
                if (patient.phone) {
                    phones.push({ type: 'å›ºå®šé›»è©±', number: patient.phone });
                }
                if (patient.mobile) {
                    phones.push({ type: 'æºå¸¯é›»è©±', number: patient.mobile });
                }
                if (patient.contact) {
                    phones.push({ type: 'é€£çµ¡å…ˆ', number: patient.contact });
                }
                
                locationGroups[locationKey].patients.push({
                    id: patient.id,
                    name: patient.name,
                    address: patient.address,
                    phones: phones,
                    risk_level: patient.risk || 'ä½',
                    notes: patient.notes || ''
                });
            });
            
            // ãƒãƒ¼ã‚«ãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆExcelå‡¦ç†æ™‚ã¨åŒã˜æ§‹é€ ï¼‰
            const markers = Object.values(locationGroups).map(group => {
                const riskPriority = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
                const maxRisk = group.patients.reduce((max, p) => {
                    return riskPriority[p.risk_level] > riskPriority[max] ? p.risk_level : max;
                }, 'ä½');
                
                return {
                    lat: group.lat,
                    lng: group.lng,
                    patients: group.patients,
                    group_risk: maxRisk,
                    count: group.patients.length,
                    address: group.patients[0].address
                };
            });
            
            return markers;
        }
        
        // åœ°å›³ä½œæˆé–¢æ•°ï¼ˆJSONèª­ã¿è¾¼ã¿ç”¨ - å€‹åˆ¥æ‚£è€…å½¢å¼ï¼‰
        async function createMap(patientMarkers) {
            // åœ°å›³åˆæœŸåŒ–
            if (map) {
                map.remove();
            }
            
            map = L.map('map', {
                center: [CLINIC_INFO.lat, CLINIC_INFO.lng],
                zoom: 14,
                zoomControl: true
            });
            
            // èƒŒæ™¯åœ°å›³
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
            
            // ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            const floodLayer = L.tileLayer(
                'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png',
                { attribution: 'å›½åœŸäº¤é€šçœ', opacity: 0.6, maxZoom: 20, maxNativeZoom: 17 }
            ).addTo(map);
            
            const doshaLayer = L.tileLayer(
                'https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png',
                { attribution: 'å›½åœŸäº¤é€šçœ', opacity: 0.6, maxZoom: 20, maxNativeZoom: 17 }
            ).addTo(map);
            
            const tsunamiLayer = L.tileLayer(
                'https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png',
                { attribution: 'å›½åœŸäº¤é€šçœ', opacity: 0.6, maxZoom: 20, maxNativeZoom: 17 }
            ).addTo(map);
            
            // äº‹æ¥­æ‰€ãƒãƒ¼ã‚«ãƒ¼
            const clinicMarker = L.marker([CLINIC_INFO.lat, CLINIC_INFO.lng], {
                icon: L.divIcon({
                    className: 'clinic-icon',
                    html: '<div style="font-size: 28px; filter: grayscale(100%) brightness(0%);">â­</div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            }).addTo(map);
            
            clinicMarker.bindPopup(`
                <div style="text-align: center; padding: 10px;">
                    <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">
                        ğŸ¥ ${CLINIC_INFO.name}
                    </div>
                    <div style="color: #7f8c8d; font-size: 0.9em;">${CLINIC_INFO.address}</div>
                </div>
            `);
            
            // æ‚£è€…ãƒãƒ¼ã‚«ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
            const patientGroup = L.featureGroup();
            
            // å€‹åˆ¥æ‚£è€…ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
            patientMarkers.forEach(patient => {
                const color = patient.risk === 'é«˜' ? '#ff0000' : 
                             patient.risk === 'ä¸­' ? '#ffaa00' : '#00cc00';
                
                const circleMarker = L.circleMarker([patient.lat, patient.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#000',
                    weight: 2,
                    opacity: 1.0,
                    fillOpacity: 0.85
                });
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½œæˆ
                let popupHTML = '<div class="patient-popup">';
                popupHTML += `<div class="address">${patient.address}</div>`;
                
                popupHTML += `<div class="patient-name">ğŸ‘¤ ${patient.name}`;
                if (patient.id) {
                    popupHTML += ` <span style="color: #95a5a6; font-size: 0.9em;">(ID: ${patient.id})</span>`;
                }
                popupHTML += '</div>';
                
                // é›»è©±ç•ªå·
                if (patient.phone || patient.mobile || patient.contact) {
                    popupHTML += '<div class="phones">';
                    if (patient.phone) {
                        popupHTML += `<a href="tel:${patient.phone.replace(/[-ï¼\s]/g, '')}" class="phone-link">ğŸ“ ${patient.phone}</a>`;
                    }
                    if (patient.mobile) {
                        popupHTML += `<a href="tel:${patient.mobile.replace(/[-ï¼\s]/g, '')}" class="phone-link">ğŸ“± ${patient.mobile}</a>`;
                    }
                    if (patient.contact) {
                        popupHTML += `<a href="tel:${patient.contact.replace(/[-ï¼\s]/g, '')}" class="phone-link">ğŸ“ ${patient.contact}</a>`;
                    }
                    popupHTML += '</div>';
                }
                
                // ãƒªã‚¹ã‚¯åˆ†é¡
                const riskColor = patient.risk === 'é«˜' ? '#ff0000' : 
                                 patient.risk === 'ä¸­' ? '#ffaa00' : '#00cc00';
                popupHTML += `<div class="risk-badge" style="background: ${riskColor};">ãƒªã‚¹ã‚¯: ${patient.risk}</div>`;
                
                // å‚™è€ƒ
                if (patient.notes) {
                    popupHTML += `<div class="notes">ğŸ“ ${patient.notes}</div>`;
                }
                
                popupHTML += '</div>';
                
                circleMarker.bindPopup(popupHTML);
                circleMarker.addTo(patientGroup);
            });
            
            patientGroup.addTo(map);
            
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            L.control.layers({}, {
                'æ´ªæ°´ï¼ˆæµ¸æ°´æ·±ï¼‰': floodLayer,
                'åœŸç ‚ç½å®³è­¦æˆ’åŒºåŸŸ': doshaLayer,
                'æ´¥æ³¢æµ¸æ°´æƒ³å®š': tsunamiLayer,
                'æ‚£è€…ãƒãƒ¼ã‚«ãƒ¼': patientGroup,
                'äº‹æ¥­æ‰€': clinicMarker
            }, {
                position: 'topright',
                collapsed: false
            }).addTo(map);
        }
        
        // JSONä¿å­˜æ©Ÿèƒ½
        function saveAsJSON() {
            if (!mapData) {
                alert('åœ°å›³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸãƒãƒ¼ã‚«ãƒ¼ã‚’æ‚£è€…é…åˆ—ã«å±•é–‹
            const patients = [];
            mapData.markers.forEach(marker => {
                marker.patients.forEach(patient => {
                    // é›»è©±ç•ªå·ã‚’å±•é–‹
                    let phone = '';
                    let mobile = '';
                    let contact = '';
                    
                    if (patient.phones && patient.phones.length > 0) {
                        patient.phones.forEach(p => {
                            if (p.type === 'å›ºå®šé›»è©±') {
                                phone = p.number;
                            } else if (p.type === 'æºå¸¯é›»è©±') {
                                mobile = p.number;
                            } else if (p.type === 'é€£çµ¡å…ˆ') {
                                contact = p.number;
                            }
                        });
                    }
                    
                    patients.push({
                        id: patient.id,
                        name: patient.name,
                        address: patient.address,
                        lat: marker.lat,
                        lng: marker.lng,
                        phone: phone,
                        mobile: mobile,
                        contact: contact,
                        risk: patient.risk_level,
                        notes: patient.notes || ''
                    });
                });
            });
            
            const bcpData = {
                version: "2.2.8",
                created: new Date().toISOString(),
                clinic: CLINIC_INFO,
                patients: patients,
                stats: mapData.stats
            };
            
            const jsonString = JSON.stringify(bcpData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `BCPåœ°å›³_${CLINIC_INFO.name}_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('âœ… BCPåœ°å›³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ãªå ´æ‰€ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚', 'success');
        }
        
        // Twitterã‚·ã‚§ã‚¢æ©Ÿèƒ½
        
        // JSONèª­ã¿è¾¼ã¿æ©Ÿèƒ½
        async function processJSON(file) {
            loader.style.display = 'block';
            status.style.display = 'none';
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const bcpData = JSON.parse(e.target.result);
                    
                    if (!bcpData.version) {
                        throw new Error('ä¸æ­£ãªBCPåœ°å›³ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
                    }
                    
                    CLINIC_INFO = bcpData.clinic;
                    const patients = bcpData.patients;
                    
                    // æ‚£è€…ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆExcelå‡¦ç†æ™‚ã¨åŒã˜æ§‹é€ ã«å¤‰æ›ï¼‰
                    const markers = groupPatientsByLocation(patients);
                    
                    // çµ±è¨ˆæƒ…å ±ã‚’å†è¨ˆç®—
                    const allPatients = markers.flatMap(m => m.patients);
                    const stats = {
                        total_patients: allPatients.length,
                        total_markers: markers.length,
                        high_risk: allPatients.filter(p => p.risk_level === 'é«˜').length,
                        mid_risk: allPatients.filter(p => p.risk_level === 'ä¸­').length,
                        low_risk: allPatients.filter(p => p.risk_level === 'ä½').length,
                        with_phone: allPatients.filter(p => p.phones && p.phones.length > 0).length
                    };
                    
                    loader.style.display = 'none';
                    showStatus(`âœ… ä¿å­˜ã•ã‚ŒãŸBCPåœ°å›³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${stats.total_patients}åï¼‰`, 'success');
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜
                    mapData = { markers, stats };
                    
                    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                    uploadScreen.style.display = 'none';
                    mapScreen.style.display = 'block';
                    
                    // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
                    document.getElementById('clinicName').textContent = `ğŸ“ ${CLINIC_INFO.name}`;
                    document.getElementById('stats').innerHTML = `
                        ç™»éŒ²æ‚£è€…: <strong>${stats.total_patients}å</strong><br>
                        é›»è©±ç•ªå·: <strong>${stats.with_phone}å</strong>
                    `;
                    document.getElementById('riskSummary').innerHTML = `
                        <div class="risk-item risk-high">ğŸ”´ é«˜<br><strong>${stats.high_risk}</strong></div>
                        <div class="risk-item risk-mid">ğŸŸ¡ ä¸­<br><strong>${stats.mid_risk}</strong></div>
                        <div class="risk-item risk-low">ğŸŸ¢ ä½<br><strong>${stats.low_risk}</strong></div>
                    `;
                    
                    // åœ°å›³åˆæœŸåŒ–ï¼ˆExcelå‡¦ç†æ™‚ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                    if (map) {
                        map.remove();
                    }
                    
                    map = L.map('map', {
                        center: [CLINIC_INFO.lat, CLINIC_INFO.lng],
                        zoom: 14,
                        zoomControl: true
                    });
                    
                    // èƒŒæ™¯åœ°å›³
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap',
                        subdomains: 'abcd',
                        maxZoom: 20
                    }).addTo(map);
                    
                    // ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
                    const floodLayer = L.tileLayer(
                        'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png',
                        { attribution: 'å›½åœŸäº¤é€šçœ', opacity: 0.6, maxZoom: 20, maxNativeZoom: 17 }
                    ).addTo(map);
                    
                    const doshaLayer = L.tileLayer(
                        'https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png',
                        { attribution: 'å›½åœŸäº¤é€šçœ', opacity: 0.6, maxZoom: 20, maxNativeZoom: 17 }
                    ).addTo(map);
                    
                    const tsunamiLayer = L.tileLayer(
                        'https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png',
                        { attribution: 'å›½åœŸäº¤é€šçœ', opacity: 0.6, maxZoom: 20, maxNativeZoom: 17 }
                    ).addTo(map);
                    
                    // äº‹æ¥­æ‰€ãƒãƒ¼ã‚«ãƒ¼
                    const clinicMarker = L.marker([CLINIC_INFO.lat, CLINIC_INFO.lng], {
                        icon: L.divIcon({
                            className: 'clinic-icon',
                            html: '<div style="font-size: 28px; filter: grayscale(100%) brightness(0%);">â­</div>',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        })
                    }).addTo(map);
                    
                    clinicMarker.bindPopup(`
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">
                                ğŸ¥ ${CLINIC_INFO.name}
                            </div>
                            <div style="color: #7f8c8d; font-size: 0.9em;">${CLINIC_INFO.address}</div>
                        </div>
                    `);
                    
                    // æ‚£è€…ãƒãƒ¼ã‚«ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
                    const patientGroup = L.featureGroup();
                    
                    // æ‚£è€…ãƒãƒ¼ã‚«ãƒ¼ä½œæˆï¼ˆExcelå‡¦ç†æ™‚ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                    markers.forEach(marker => {
                        const color = marker.group_risk === 'é«˜' ? '#ff0000' : 
                                     marker.group_risk === 'ä¸­' ? '#ffaa00' : '#00cc00';
                        
                        const radius = marker.count === 1 ? 8 : Math.min(8 + marker.count * 0.5, 16);
                        
                        const circleMarker = L.circleMarker([marker.lat, marker.lng], {
                            radius: radius,
                            fillColor: color,
                            color: '#000',
                            weight: 2,
                            opacity: 1.0,
                            fillOpacity: 0.85
                        });
                        
                        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½œæˆ
                        let popupHTML = '<div class="patient-popup">';
                        
                        if (marker.count > 1) {
                            popupHTML += `<div class="patient-count">${marker.count}å</div>`;
                        }
                        
                        marker.patients.forEach((patient, index) => {
                            if (index > 0) popupHTML += '<hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">';
                            
                            popupHTML += `<div class="patient-name">ğŸ‘¤ ${patient.name}`;
                            if (patient.id) {
                                popupHTML += ` <span style="color: #95a5a6; font-size: 0.9em;">(ID: ${patient.id})</span>`;
                            }
                            popupHTML += '</div>';
                            
                            popupHTML += `<div class="address">${patient.address}</div>`;
                            
                            // é›»è©±ç•ªå·
                            if (patient.phones && patient.phones.length > 0) {
                                popupHTML += '<div class="phones">';
                                patient.phones.forEach(phone => {
                                    const icon = phone.type === 'å›ºå®šé›»è©±' ? 'ğŸ“' : 'ğŸ“±';
                                    popupHTML += `<a href="tel:${phone.number.replace(/[-ï¼\s]/g, '')}" class="phone-link">${icon} ${phone.number}</a>`;
                                });
                                popupHTML += '</div>';
                            }
                            
                            // ãƒªã‚¹ã‚¯åˆ†é¡
                            const riskColor = patient.risk_level === 'é«˜' ? '#ff0000' : 
                                             patient.risk_level === 'ä¸­' ? '#ffaa00' : '#00cc00';
                            popupHTML += `<div class="risk-badge" style="background: ${riskColor};">ãƒªã‚¹ã‚¯: ${patient.risk_level}</div>`;
                            
                            // å‚™è€ƒ
                            if (patient.notes) {
                                popupHTML += `<div class="notes">ğŸ“ ${patient.notes}</div>`;
                            }
                        });
                        
                        popupHTML += '</div>';
                        
                        circleMarker.bindPopup(popupHTML);
                        circleMarker.addTo(patientGroup);
                    });
                    
                    patientGroup.addTo(map);
                    
                    // å…¨æ‚£è€…ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚ºãƒ¼ãƒ èª¿æ•´
                    if (markers.length > 0) {
                        const bounds = patientGroup.getBounds();
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                    
                } catch (error) {
                    loader.style.display = 'none';
                    showStatus('âŒ JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // CSVå‡¦ç†æ©Ÿèƒ½
        async function processCSV(file) {
            loader.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csvText = e.target.result;
                    const lines = csvText.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    
                    const headers = lines[0].split(',').map(h => h.trim().replace(/^["']|["']$/g, ''));
                    showColumnMapping(headers, lines.slice(1));
                    
                } catch (error) {
                    loader.style.display = 'none';
                    showStatus('âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        // CSVåˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ç”»é¢
        function showColumnMapping(headers, dataLines) {
            loader.style.display = 'none';
            
            const mappingDiv = document.createElement('div');
            mappingDiv.id = 'columnMapping';
            mappingDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 10001;';
            
            const requiredColumns = [
                { key: 'id', label: 'æ‚£è€…ç•ªå·', examples: ['æ‚£è€…ç•ªå·', 'æ‚£è€…ID', 'ID', 'ç•ªå·'] },
                { key: 'name', label: 'æ‚£è€…æ°å', examples: ['æ‚£è€…æ°å', 'æ‚£è€…å', 'æ°å', 'åå‰'] },
                { key: 'address', label: 'è‡ªå®…ä½æ‰€', examples: ['è‡ªå®…ä½æ‰€', 'ä½æ‰€', 'ä½æ‰€1'] },
                { key: 'phone', label: 'è‡ªå®…é›»è©±ç•ªå·', examples: ['è‡ªå®…é›»è©±ç•ªå·', 'é›»è©±ç•ªå·', 'å›ºå®šé›»è©±', 'TEL'] },
                { key: 'mobile', label: 'ãã®ä»–ã®é›»è©±ç•ªå·', examples: ['ãã®ä»–ã®é›»è©±ç•ªå·', 'æºå¸¯ç•ªå·', 'æºå¸¯é›»è©±', 'æºå¸¯'] }
            ];
            
            const autoMapping = {};
            requiredColumns.forEach(col => {
                const matched = headers.find(h => col.examples.some(ex => h.includes(ex) || ex.includes(h)));
                autoMapping[col.key] = matched || headers[0];
            });
            
            let mappingHTML = `<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; max-height: 85vh; overflow-y: auto;">
                <h2 style="margin-top: 0; color: #2c3e50;">ğŸ“‹ åˆ—ã®å¯¾å¿œä»˜ã‘</h2>
                <p style="color: #7f8c8d;">CSVã®åˆ—åã¨ã‚¢ãƒ—ãƒªã®é …ç›®ã‚’å¯¾å¿œä»˜ã‘ã¦ãã ã•ã„</p>
                <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <tr style="background: #ecf0f1;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #bdc3c7;">ã‚¢ãƒ—ãƒªã®é …ç›®</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #bdc3c7;">CSVã®åˆ—</th>
                    </tr>`;
            
            requiredColumns.forEach(col => {
                mappingHTML += `<tr>
                    <td style="padding: 10px; border: 1px solid #bdc3c7;"><strong>${col.label}</strong> ${['id','name','address'].includes(col.key) ? '<span style="color: red;">*</span>' : ''}</td>
                    <td style="padding: 10px; border: 1px solid #bdc3c7;">
                        <select id="map_${col.key}" style="width: 100%; padding: 5px;">
                            <option value="">ï¼ˆãªã—ï¼‰</option>
                            ${headers.map(h => `<option value="${h}" ${autoMapping[col.key] === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </td>
                </tr>`;
            });
            
            mappingHTML += `</table>
                <p style="color: #e74c3c; font-size: 14px;">* å¿…é ˆé …ç›®</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="applyCSVMapping()" style="flex: 1; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">å¤‰æ›å®Ÿè¡Œ</button>
                    <button onclick="document.getElementById('columnMapping').remove(); uploadScreen.style.display='flex';" style="flex: 1; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>`;
            
            mappingDiv.innerHTML = mappingHTML;
            document.body.appendChild(mappingDiv);
            
            window.csvHeaders = headers;
            window.csvDataLines = dataLines;
        }
        
        // CSVå¤‰æ›å®Ÿè¡Œ
        async function applyCSVMapping() {
            const mapping = {
                id: document.getElementById('map_id').value,
                name: document.getElementById('map_name').value,
                address: document.getElementById('map_address').value,
                phone: document.getElementById('map_phone').value,
                mobile: document.getElementById('map_mobile').value
            };
            
            if (!mapping.id || !mapping.name || !mapping.address) {
                alert('æ‚£è€…ç•ªå·ã€æ‚£è€…æ°åã€è‡ªå®…ä½æ‰€ã¯å¿…é ˆé …ç›®ã§ã™');
                return;
            }
            
            document.getElementById('columnMapping').remove();
            
            const headers = window.csvHeaders;
            const lines = window.csvDataLines;
            
            const jsonData = lines.map(line => {
                const values = line.split(',').map(v => v.trim().replace(/^["']|["']$/g, ''));
                const row = {};
                headers.forEach((h, i) => { row[h] = values[i] || ''; });
                return row;
            }).filter(row => row[mapping.id]);
            
            const convertedData = jsonData.map(row => ({
                'æ‚£è€…ç•ªå·': row[mapping.id],
                'æ‚£è€…æ°å': row[mapping.name],
                'è‡ªå®…ä½æ‰€': row[mapping.address],
                'è‡ªå®…é›»è©±ç•ªå·': row[mapping.phone] || '',
                'ãã®ä»–ã®é›»è©±ç•ªå·': row[mapping.mobile] || ''
            }));
            
            loader.style.display = 'block';
            await processConvertedData(convertedData);
        }
        
        // å¤‰æ›å¾Œãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆå®Ÿè£…ã¯é•·ã„ã®ã§ã“ã“ã§ã¯çœç•¥ã—ã€å…ƒã®Excelå‡¦ç†ã‚’æµç”¨ï¼‰
        async function processConvertedData(jsonData) {
            // Excelå‡¦ç†ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
            // ç°¡ç•¥åŒ–ã®ãŸã‚ã€Excelå‡¦ç†ã®ä¸»è¦éƒ¨åˆ†ã‚’å†åˆ©ç”¨
            geocodingErrors = [];
            
            try {
                const nameCol = findColumn(jsonData, ['æ‚£è€…æ°å', 'æ‚£è€…åå‰', 'æ°å', 'åå‰']);
                const addressCol = findColumn(jsonData, ['è‡ªå®…ä½æ‰€', 'ä½æ‰€', 'ä½æ‰€1']);
                
                if (!addressCol) throw new Error('ä½æ‰€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                
                const total = jsonData.length;
                const markers = [];
                
                progressContainer.style.display = 'block';
                progressLabel.textContent = 'åº§æ¨™å¤‰æ›ä¸­...';
                
                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    const address = row[addressCol];
                    if (!address) continue;
                    
                    const progress = ((i + 1) / total * 100).toFixed(0);
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    progressPercent.textContent = progress + '%';
                    progressStatus.textContent = `${i + 1} / ${total}`;
                    
                    const coords = await geocodeAddress(address);
                    
                    if (coords) {
                        const phoneCol = findColumn(jsonData, ['è‡ªå®…é›»è©±ç•ªå·', 'é›»è©±ç•ªå·', 'å›ºå®šé›»è©±', 'TEL']);
                        const mobileCol = findColumn(jsonData, ['ãã®ä»–ã®é›»è©±ç•ªå·', 'æºå¸¯ç•ªå·', 'æºå¸¯é›»è©±', 'æºå¸¯']);
                        
                        let phone = phoneCol ? String(row[phoneCol] || '') : '';
                        let mobile = mobileCol ? String(row[mobileCol] || '') : '';
                        
                        if (phone && !phone.startsWith('0') && phone.length >= 6) {
                            const originalPhone = phone;
                            phone = autoCompleteAreaCode(phone, address);
                            if (phone !== originalPhone) {
                                areaCodeAdjustments.push({ name: row[nameCol] || '', original: originalPhone, adjusted: phone });
                            }
                        }
                        
                        markers.push({
                            id: row['æ‚£è€…ç•ªå·'] || '',
                            name: row[nameCol] || 'åå‰ä¸æ˜',
                            address: address,
                            lat: coords.lat,
                            lng: coords.lng,
                            phone: phone,
                            mobile: mobile,
                            contact: '',
                            risk: row['ãƒªã‚¹ã‚¯åˆ†é¡'] || 'ä½',
                            notes: row['å‚™è€ƒ'] || ''
                        });
                    } else {
                        geocodingErrors.push({ name: row[nameCol] || 'åå‰ä¸æ˜', address: address });
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                progressContainer.style.display = 'none';
                loader.style.display = 'none';
                
                if (markers.length === 0) throw new Error('æœ‰åŠ¹ãªåº§æ¨™ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                
                const stats = calculateStats(markers);
                
                if (areaCodeAdjustments.length > 0 || geocodingErrors.length > 0) {
                    let message = `âœ… åœ°å›³ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆ${markers.length}/${total}åï¼‰`;
                    if (areaCodeAdjustments.length > 0) message += `\nğŸ“ å¸‚å¤–å±€ç•ªã‚’è‡ªå‹•è¿½åŠ : ${areaCodeAdjustments.length}ä»¶`;
                    if (geocodingErrors.length > 0) message += `\nâš ï¸ åº§æ¨™å–å¾—å¤±æ•—: ${geocodingErrors.length}ä»¶`;
                    showStatus(message, 'info');
                }
                
                mapData = { markers, stats };
                uploadScreen.style.display = 'none';
                mapScreen.style.display = 'block';
                
                document.getElementById('clinicName').textContent = `ğŸ“ ${CLINIC_INFO.name}`;
                document.getElementById('stats').innerHTML = `ç™»éŒ²æ‚£è€…: <strong>${stats.total_patients}å</strong><br>é›»è©±ç•ªå·: <strong>${stats.with_phone}å</strong>`;
                document.getElementById('riskSummary').innerHTML = `
                    <div class="risk-item risk-high">ğŸ”´ é«˜<br><strong>${stats.high_risk}</strong></div>
                    <div class="risk-item risk-mid">ğŸŸ¡ ä¸­<br><strong>${stats.mid_risk}</strong></div>
                    <div class="risk-item risk-low">ğŸŸ¢ ä½<br><strong>${stats.low_risk}</strong></div>
                `;
                
                setTimeout(() => showSecurityWarning(), 2000);
                
                if (map) map.remove();
                await createMap(markers);
                
            } catch (error) {
                loader.style.display = 'none';
                progressContainer.style.display = 'none';
                showStatus('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }
        
    </script>
</body>
</html>
